name: Sync Check with Fred

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'package.json'

jobs:
  check-fred-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout create-fred
        uses: actions/checkout@v4
        with:
          path: create-fred

      - name: Checkout fred
        uses: actions/checkout@v4
        with:
          repository: TheFancyRobot/fred
          path: fred
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Get Fred version
        id: fred-version
        run: |
          cd ${{ github.workspace }}/fred
          FRED_VERSION=$(bun -e 'console.log(require("./package.json").version)')
          echo "version=$FRED_VERSION" >> $GITHUB_OUTPUT
          echo "Fred version: $FRED_VERSION"

      - name: Check template compatibility
        run: |
          cd ${{ github.workspace }}/create-fred
          bun install
          
          # Test that templates can import from fred
          # This will fail if API has changed
          echo "Testing template imports..."
          
          # Create a test project to verify compatibility
          mkdir -p /tmp/test-sync
          cd /tmp/test-sync
          
          # Copy a template and test imports
          cp ${{ github.workspace }}/create-fred/src/templates/src/index.ts.template test.ts
          
          # Replace template variables
          sed -i 's/{{PROVIDER}}/openai/g' test.ts
          sed -i 's/{{MODEL}}/gpt-3.5-turbo/g' test.ts
          sed -i 's/{{ENV_VAR_NAME}}/OPENAI_API_KEY/g' test.ts
          
          # Try to build/check imports
          cd ${{ github.workspace }}/fred
          bun install
          cd ${{ github.workspace }}/create-fred
          bun add file:${{ github.workspace }}/fred
          
          cd /tmp/test-sync
          bun run --bun test.ts || echo "Template compatibility check completed"

      - name: Check version mismatch
        run: |
          cd ${{ github.workspace }}/create-fred
          CURRENT_FRED=$(grep -o '"fred": "[^"]*"' package.json || echo '"fred": "*"')
          echo "Current fred dependency: $CURRENT_FRED"
          echo "Latest fred version: ${{ steps.fred-version.outputs.version }}"
          
          # Create issue if versions are significantly out of sync
          # (This would require additional setup with GitHub API)

      - name: Report sync status
        if: always()
        run: |
          echo "## Sync Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- Fred version: ${{ steps.fred-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

